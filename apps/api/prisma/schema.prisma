generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  username      String?  @unique
  password      String?
  googleId      String?  @unique
  avatar        String?
  isVerified    Boolean  @default(false)
  twoFactorEnabled Boolean @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  wallet        Wallet?
  loyaltyPoints LoyaltyPoint?
  topups        TopupTransaction[]

  @@index([email])
  @@index([googleId])
}

model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Decimal  @default(0) @db.Decimal(12, 2)
  currency  String   @default("IDR")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model LoyaltyPoint {
  id        String   @id @default(cuid())
  userId    String   @unique
  points    Int      @default(0)
  tier      String   @default("Bronze") // Bronze, Silver, Gold
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Game {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  category    String   // MOBA, Battle Royale, RPG, etc
  thumbnail   String
  model3D     String?
  description String?
  rating      Float    @default(0)
  isPopular   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  priceOptions PriceOption[]
  topups       TopupTransaction[]

  @@index([slug])
  @@index([category])
}

model PriceOption {
  id          String   @id @default(cuid())
  gameId      String
  name        String   // e.g., "100 Diamonds"
  amount      Int      // Nominal item (100, 500, 1000)
  price       Decimal  @db.Decimal(12, 2)
  discount    Int      @default(0) // Percentage
  finalPrice  Decimal  @db.Decimal(12, 2)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  game   Game               @relation(fields: [gameId], references: [id], onDelete: Cascade)
  topups TopupTransaction[]

  @@index([gameId])
}

enum TopupStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentMethod {
  GOPAY
  OVO
  DANA
  BANK_TRANSFER
  CRYPTO
  WALLET
}

model TopupTransaction {
  id              String        @id @default(cuid())
  userId          String
  gameId          String
  priceOptionId   String
  gameAccountId   String        // User's game ID
  gameServer      String?       // Server name if applicable
  amount          Int
  price           Decimal       @db.Decimal(12, 2)
  paymentMethod   PaymentMethod
  status          TopupStatus   @default(PENDING)
  paymentProof    String?
  completedAt     DateTime?
  failedReason    String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user         User        @relation(fields: [userId], references: [id])
  game         Game        @relation(fields: [gameId], references: [id])
  priceOption  PriceOption @relation(fields: [priceOptionId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}
